---
theme: night
height: 540
margin: 0
maxScale: 4
slideNumber: true
---

<!-- slide bg="[[Green Logo.svg]]" background-size="auto" -->

---


<!-- slide template="[[Split Vertical]]" -->
::: title
#### CS-4973
:::
::: left
![[Green Logo.svg | 400]] <!-- element style="object-fit: cover" -->

:::
::: right
<!-- element style="font-size: 32px;align:center" -->
Introduction to Malware, Threat Hunting & Offensive Capabilities Development
:::

---
<!-- slide template="[[Title Slide]]" -->
 ## Cryptography and Ransomware 
---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Agenda for Today

:::

<!-- element style="font-size: 24px"-->
- More informal Security Definitions 
- Asymmetric  Cryptography  
- Hybrid Schemes 
- Ransomware 

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Ransomware 
:::

::: left
<!-- element style="font-size: 24px"-->
- Malware that 
encrypts
 sensitive data, and 
extorts
 victims for the decryption key
- If done “
properly”
, the data is at the mercy of the ransomware operator  

:::

::: right
![[0x0f_5717df17d92f5c89_slide_4_image.png|500]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Ransomware as a service 

:::

<!-- element style="font-size: 24px"-->
- Many threat actors use an affiliate model, where affiliates (possible 3rd party operators) penetrate networks, and deploy ransomware
- The Ransomware group maintains the infrastructure to encrypt networks, and communicate with victims 
- In exchange, the affiliates share a percentage of their ransom

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Discussion: Monetizing Access
:::

<!-- element style="font-size: 24px"-->
- Ransomware is one way of *monetizing access*
- Others include stealers, access brokers (usually bots/loaders), IP theft...etc
- Ransomware requires the least amount of enumeration, and can be  used alongside other monetization strategies 
- At the end of the day, it is a (multi billion dollar) business
- What happens when a business becomes flush with cash?
---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Ransomware Gangs

:::

<!-- element style="font-size: 24px"-->
- Ryuk
- CL0p
- LockBit
- Black Cat
- Conti 
- REvil (RIP)
- Avaddon (RIP) 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Ransomware (cont)

:::

<!-- element style="font-size: 24px"-->
- Can target any platform, but usual targets are
	- ESXI, Windows, Linux, Mac 
- Most will not encrypt files critical to the operation of the OS, but might encrypt entire virtual machine hard disks  
- Most ransomware doesn’t require communication with a C2 server to encrypt files!

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Extortion and Ransomware
:::

::: left
<!-- element style="font-size: 24px"-->
- Frequently, victim data is uploaded to a remote server before being encrypted
- This gives the affiliates/operators more leverage over the victims
- “Pay us or never get your files back” is not as scary as “Pay us or we leak all your data”

:::

::: right
![[0x0f_5717df17d92f5c89_slide_8_image.png|500]]


:::

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### How does ransomware work?
:::

::: left
<!-- element style="font-size: 24px"-->
- Gain execution on a host
- Enumerate files
- Filter files that are 
sensitive
/not critical to OS function
- Encrypt the files 
- Make your 
presence
 known (Leave a 
ransom note
- Extract payment, and provide decryptor 


:::

::: right
![[0x0f_5717df17d92f5c89_slide_9_image.png|500]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Ransomware internals: Encryptor

:::

<!-- element style="font-size: 24px"-->
- Key properties…*badum tsssss*
- Ransomware uses cryptography to encrypt files even in the event that the executable is leaked.
- Ransomware does not require an internet connection to be successful
- Ransomware needs to be efficient in time and space (why?)

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Disclaimers

:::

<!-- element style="font-size: 24px"-->
- Don't build ransomware. Even if it is just for "Educational purposes only". I shouldn't have to say this, yet here we are. I will fail you, retroactively or otherwise. 
- Cryptography is hard. 
- We will make use of informal definitions, and take shortcuts when introducing concepts. 
- For a more rigorous treatment, see Dan Boneh’s Coursera class. It is  fantastic and free! 


---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### TLDR
:::

::: left
<!-- element style="font-size: 24px"-->
- Cryptography is very difficult to “get right” depending the adversary. 
- You probably should not “roll your own” crypto if your privacy and integrity requirements are critical.  You have been warned!
- Crypto is also often times not 
sufficient on its own!
- Example: signal vs whatsapp
- https://xkcd.com/538/


:::

::: right
![[0x0f_5717df17d92f5c89_slide_13_image.png|500]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Again. Don’t build your own crypto
:::


![[0x0f_5717df17d92f5c89_slide_14_image.png|700]]



---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Basic concepts 
:::

::: left
<!-- element style="font-size: 24px"-->
- Basic Combinatorics: Counting Bit strings
- Basic Probability: Needle in a haystack
- “Hard” math problems 
- Complexity theory

:::

::: right
![[0x0f_5717df17d92f5c89_slide_15_image.png|200]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Ransomware: Attempt 1

:::

<!-- element style="font-size: 24px"-->
- Store symmetric key in implant
- Use symmetric key to encrypt files on disk 
- Delete symmetric key and store symmetric key on remote server
- Once the ransom is paid: send symmetric key to the victim


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Key Recovery 

:::

<!-- element style="font-size: 24px"-->
- If the defenders get their hands on a sample (which they probably will!)  the symmetric key will be recoverable from the binary


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Attempt 2

:::

<!-- element style="font-size: 24px"-->
- Download the symmetric key from a remote server, encrypt the files, and delete the key 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Key Recovery 

:::

<!-- element style="font-size: 24px"-->
- Better, but still flawed!
- How does the implant authenticate itself to the remote server and prevent a defender form downloading the key?
- What about if the defender MITMs network communication?

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Advice for Key recovery

:::

<!-- element style="font-size: 24px"-->
- Statically: hard if they hide it
- Dynamically: usually easy. Find the function that encrypts/decrypts and just set a breakpoint. How do you find that function? 
- Set breakpoints on common WinCrypt API functions
- Look for common cryptographic constants
- Trace your way backwards after network communication...etc


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Attempt 3: Asymmetric encryption

:::

<!-- element style="font-size: 24px"-->
- Use 
asymmetric
 encryption and store the private key on the server!


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Asymmetric Cryptography 

:::

<!-- element style="font-size: 24px"-->
- AKA (Public Key Cryptography)
- How do continue to communicate with someone I have met once?
- How do we securely communicate with someone we have never met before?
- Classic examples: 
- how does your browser establish a secure connection with google.com?

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Public Key Encryption
:::

::: left
<!-- element style="font-size: 24px"-->
- Anybody with the public key can encrypt messages
- Only the owner of the private key can decrypt messages
- Limitation: way slower than symmetric encryption, and has a limited message size!

:::

::: right
![[0x0f_5717df17d92f5c89_slide_36_image.png|250]]


:::

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### What does ransomware actually use?
:::

::: left
<!-- element style="font-size: 24px"-->
- Public key cryptography and symmetric 
cryptography


:::

::: right
![[0x0f_5717df17d92f5c89_slide_37_image.png|300]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Ransomware
:::


![[0x0f_5717df17d92f5c89_slide_38_image.png]]




---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Ransomware 
:::

::: left
<!-- element style="font-size: 24px"-->
- Composed of the locker and (if they act in “good faith”) a decryptor
- The 
locker 
is the executable that encrypts files
- The 
decryptor
 is the application that decrypts files


:::

::: right
![[0x0f_5717df17d92f5c89_slide_39_image.png|300]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Locker

:::

<!-- element style="font-size: 24px"-->
- Typically use 
hybrid schemes
- That is, they combine asymmetric cryptography with symmetric cryptography
- Asymmetric cryptography usually has a size limit and is slower
- Symmetric cryptography, when used properly, does not and is 
significantly 
faster. 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Locker Hybrid Scheme 

:::

<!-- element style="font-size: 24px"-->
- Store public key on the Implant
- For each file of interest:
	- Randomly generate a strong symmetric key
	- Encrypt files using symmetric key
	- Encrypt Symmetric key with public key
	- “Shred” symmetric key
- Drop ransomware note 
- Implant doesn’t need to know the private key to encrypt the symmetric keys!


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Decryptor Hybrid scheme  

:::

<!-- element style="font-size: 24px"-->
- For each locked file:
- Load the encrypted symmetric key 
- Decrypt the symmetric key using the private key
- Use the symmetric key to decrypt the file 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Examples

:::

<!-- element style="font-size: 24px"-->
- RSA
- El Gamal
- Various using Elliptic Curves


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Common Mistakes

:::

<!-- element style="font-size: 24px"-->
- Key reuse ( Public/Private key pairs...etc)
- Small modulus (El Gammal)
- Weak PRNG to generate symmetric keys (using mouse position)
- Buggy implementations 

---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Key Reuse:
:::

![[0x0f_5717df17d92f5c89_slide_45_image.png|500]]

<small>
https://www.technologyreview.com/2021/05/24/1025195/colonial-pipeline-ransomware-bitdefender/


---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Communication with Public Keys
:::

![[0x0f_5717df17d92f5c89_slide_46_image.png]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Crowded Room Key sharing 

:::

<!-- element style="font-size: 24px"-->
- Cryptography is magic
- Imagine walking into a crowded room and shouting something at your friend.
- Your friend hears you, shouts something back, and you miraculously walk away with a secret key. 
- In particular, it is secret from everyone else in the room!

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Example: Diffie Hellman
:::

::: left
<!-- element style="font-size: 24px"-->
- Key agreement protocol
- Easy(ish) to implement, but requires very large modulus, with very large prime factors


:::

::: right
![[0x0f_5717df17d92f5c89_slide_48_image.png]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Crowded Room Key sharing 

:::

<!-- element style="font-size: 24px"-->
- Cryptography is magic
- Imagine walking into a crowded room and shouting something at your friend.
- Your friend hears you, shouts something back, and you miraculously walk away with a secret key. 
- In particular, it is secret from everyone else in the room!
- What does this look like in practice? Glad you asked…

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Diffie Hellman 


:::

<!-- element style="font-size: 24px"-->
- Based on the Discrete Logarithm problem, + some other assumptions
- How does it work…?


---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Diffie Hellman key Exchange
:::

<iframe src="https://drive.google.com/file/d/117fkcqThJhiqhF2DwQz9dmxbHPgX3nd5/preview" width="640" height="480" allow="autoplay"></iframe>

:::
---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Gotchas 
:::
- We can't all be shouting cowboys who just *know* we're talking to the correct person
- What if we cannot authenticate our peer? Are we still safe?



---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Why do CAs exist?  
:::

::: left
<!-- element style="font-size: 24px"-->
- Certificate Authorities: The trusted 3rd parties that issue Certificates
- Certificates: A cryptographic object used to authenticate an entity 
- Informal: A hacky solution for preventing MITM attacks when peers cannot authenticate each other
- Example: MITM DHKE 


:::

::: right
![[0xff_b7740e7cc899855a_slide_5_image.png|300]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Refresher: Why do CAs exist? 
:::

![[0xff_b7740e7cc899855a_slide_6_image.png]]


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Attacks on PKI

:::
How do we know which trusted 3rd parties to *trust*?

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Attacks on PKI

:::
The list of trusted Certificate Authorities is (usually) shipped with the OS. Many browsers also have a hard coded list of *trusted* Certificate Authorities  

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Attacks on PKI

:::
If someone is able to install a rogue Certificate Authority, they can perform a MITM attack. This is exactly how tools like Burpsuite allow you to decrypt traffic!

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example Scenario 

:::

<!-- element style="font-size: 24px"-->
- During an operation, you find an authentication oracle that allows you to perform a password spraying attack
- As luck would have it, john.doe@thiscorp.com  is using ‘Spring2023!’ as their password
- You then login to their corporate network and find yourself on a Windows machine. You cannot believe your luck!
- You decide to detonate an implant to establish a remote connection from your attack server to the corporate network
- Your malware uses TLS to encrypt its communication
- The implant beacons back to your attack server then immediately dies
- What happened?

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Possible Explanations
:::
- Your IP is blacklisted
- Your Domain is Blacklisted or you aren't using a domain
- You attempted to egress off of an uncommon port 
- It couldn't possibly be they found something in your TLS packets...Right?

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Debugging
:::
<!-- element style="font-size: 24px"-->
- If one IP is blacklisted, try another. Maybe even try one that is *trusted* to rule this out (think Cloudflare, AWS, ...etc)
- If a domain is blacklisted, find one that isn't. Or use domain Fronting (harder now a days )
- If you tried to egress over an uncommon port, make sure you don't do that :-)
- Use a protocol that is *common* for egress 

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Common Egress Ports
:::

::: left
<!-- element style="font-size: 24px"-->
- T1043: 
Commonly Used Port
	- HTTP : 80
	- HTTPS : 443
	- DNS: 53
- Why does so much malware use HTTP for its C2 Coms?

:::

::: right
![[0xff_b7740e7cc899855a_slide_3_image.png|500]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Benefits of Using Common ports 

:::
<!-- element style="font-size: 24px"-->
- From the SOC’s perspective, it is not suspicious  to see traffic egress via 80,443
- If communication is encrypted, and traffic is sent to an 
innocuous
 enough server, it is tough to distinguish malicious traffic from usual web browsing 
- This is why many corporate
 networks implement certificate pinning with a custom root certificate
 - They also often will only allow HTTP traffic to egress via an HTTP proxy 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Certificate Pinning On Corporate Networks 

:::

<!-- element style="font-size: 24px"-->
- Many corporate networks will have root certificates installed on all browsers by default
- Combined with default proxy settings, this allows the SOC to intercept, decrypt, inspect, and re-encrypt all  HTTPs communications 
- As a result, implants that 
solely
 rely on TLS will not be able to hide communications from the SOC
- This means they can inspect the payload of each message and search it for common signatures. 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Security Requirements for C2 Comms

:::

<!-- element style="font-size: 24px"-->
- At the very least, we want 
communications
 with our C2 server to have perfect forward secrecy (PFS)
- Why? 
	- You can slow down reverse 
engineers
 but they will 
eventually
 understand what your malware does
	- With PFS, if one session gets 
compromised
, only communications sent during that session are decryptable. This is a must have when dealing with keys that have a high likelihood of getting burned!


---
<!-- slide template="[[Base Slide]]" -->
::: title
###### Attempt #1: Restrict  TLS Supported Ciphersuites 

:::

<!-- element style="font-size: 24px"-->
- We could simply restrict the ciphersuites that we support to only include those that have PFS
- Great! 
This works  for traffic moving across the internet
	- Unless of course a CA get popped 
- Client and server can exchange public keys, and then begin encrypting message traffic using those keys
- After all, public keys should be public no?
- This fails in the same capacity as DHKE when an internal network proxy is introduced with a rogue CA trusted!
- This fails  to prevent attacks against distributing the public keys.


---
<!-- slide template="[[Base Slide]]" -->
::: title
###### Attempt #2: Use Certificate pinning!

:::

<!-- element style="font-size: 24px"-->
- Fine, lets just store our C2 server's public certificate, and only communicate if the presented certificate matches the one we stored
- This practice is called Certificate pinning and is common in, among other things, mobile apps to make reverse engineering harder
- What is the problem here?
- We want to egress even if the certificates do not match! <!-- element class="fragment" -->
---
<!-- slide template="[[Base Slide]]" -->
::: title
###### Attempt #3: Hardcode Public Keys for Negotiating Sessions  
:::

<!-- element style="font-size: 24px"-->
- One option, and it is one that is employed by 
Cobalt Strike Beacon, is to set a public key for the implant at compilation
- This would eliminate the problem of having to negotiate keys 
- Public keys can be (and are!)  used as signatures.  

---
<!-- slide template="[[Base Slide]]" -->
::: title
##### Attempt #4: PAKE  
:::

<!-- element style="font-size: 24px"-->
- While by no means the only approach, one that works reasonably well is to use a password authenticated key agreement (PAKE)
- Essentially, you store a "password" on the implant and the server (a pre shared key)
- This key is used to establish an initial encrypted channel. 
- A key exchange then takes place inside of the encrypted channel and a session key is derived
- For the remainder of the session, the symmetric key is used to encrypt data

---
<!-- slide template="[[Base Slide]]" -->
::: title
##### Discussion of C2 Protocol
:::