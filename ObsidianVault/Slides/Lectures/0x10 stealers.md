---
theme: night
height: 540
margin: 0
maxScale: 4
slideNumber: true
---

<!-- slide bg="[[Green Logo.svg]]" background-size="auto" -->

---


<!-- slide template="[[Split Vertical]]" -->
::: title
#### CS-4973
:::
::: left
![[Green Logo.svg | 400]] <!-- element style="object-fit: cover" -->

:::
::: right
<!-- element style="font-size: 32px;align:center" -->
Introduction to Malware, Threat Hunting & Offensive Capabilities Development
:::


---
<!-- slide template="[[Title Slide]]" -->
 ## 0x10 Stealers
---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Stealers 
:::

::: left
<!-- element style="font-size: 24px"-->
- What do stealers do?


:::

::: right
![[0x10_9370f4ef4d2c97a8_slide_2_image.png|300]]


:::

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Stealers 
:::

::: left
<!-- element style="font-size: 24px"-->
- What do stealers do?
- They steal stuff. 


:::

::: right
![[0x10_9370f4ef4d2c97a8_slide_3_image.png|300]]


:::

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Stealers 
:::

::: left
<!-- element style="font-size: 24px"-->
- They steal stuff. 
- More formally, stealers in this class will refer to any malware that is 
- Part of a Post Exploitation task 
- Uploads sensitive victim data to a C2


:::

::: right
![[0x10_9370f4ef4d2c97a8_slide_4_image.png|300]]


:::

---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Stealers 
:::

::: left
<!-- element style="font-size: 24px"-->
- Browser data: Cookies, history, passwords
- Secrets: password manager databases, ssh keys, RDP profiles, Crypto Wallet Private keys, Certificates...etc
- Documents …really anything 

:::

::: right
![[0x10_9370f4ef4d2c97a8_slide_5_image.png|300]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example Stealers:

:::

<!-- element style="font-size: 24px"-->
- Racoon 
- Azorult
- Vidar
- Loki
- Redline

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Stealers: Browsers

:::

<!-- element style="font-size: 24px"-->
- Most browsers (firefox, Chrome, Edge, Opera, Brave...etc) store all of the user data in an encrypted SQLite database
- The path for that database is predictable, and can be read
- These values include cookies, usernames, passwords, autofill data, history, ...etc
- Luckily, enough people complained that the values were stored in plaintext, and most browsers  encrypt the values in the database! So we are SOL right?

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Windows: Doing weird crypto stuff since 1985 

:::

<!-- element style="font-size: 24px"-->
- Time 
permitting
, we will discuss the Data Protection API (DAPI) in greater depth, but for now, a few important points:
- Most browsers will use the DPAPI to encrypt symmetric keys used to decrypt passwords 
- The DAPI is Token based→ ergo if the browser is used by User “John Doe”, then any processes with the “John Doe”’s token can decrypt values that were encrypted with the DAPI that 
targeted
 that user’s token
- In other words, if we trick John into running our program, we can recover his encrypted browser passwords and decrypt them!


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### How to Loot chrome (old)

:::

<!-- element style="font-size: 24px"-->
- The data is stored at `C:\Users\User\AppData\Local\Google\Chrome\User Data\default\Login Data`
- The value itself is encrypted with the DPAPI, and can be easily recovered by calling CryptUnprotectData from a process that has the same token as the logged in user. 
- To do this, we must parse the SQLite database and decrypt each value 

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### How to Loot Chrome (new)

:::

<!-- element style="font-size: 24px"-->
- Chrome stores the secret key that was used to encrypt 
passwords
 and other data inside of a configuration file 
- `C:\Users\<User>\AppData\Local\Google\Chrome\User Data\Local State`
- This is a JSON file that contains the secret key,  that is encrypted with the DAPI. 
- To decrypt the values in the SQLite database, we must 
- First parse the encrypted key
- Second, decrypt the key with the DPAPI
- Finally, we decrypt the data inside of the SQLite database 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Encryption Libraries 

:::

<!-- element style="font-size: 24px"-->
- Python: pycryptodome, 
cryptography
 (prefered) 
- C: To name a few: OpenSSL (Pain), 
Libsodium
, NACL, LibHydrogen, Monocyper
- Windows: Crypto API (Sus)
- When it comes to crypto, you probably want to use someone else’s implementation. We will talk more about this next week. 


---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Read the Documentation! 
:::

::: left
<!-- element style="font-size: 24px"-->
-  https://docs.microsoft.com/en-us/windows/win32/api/dpapi/nf-dpapi-cryptunprotectdata

:::

::: right
![[0x10_9370f4ef4d2c97a8_slide_12_image.png|300]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example: Using Python to Recover Passwords 

:::

<!-- element style="font-size: 24px"-->
- Demo


---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Other Useful Files
:::

::: left
<!-- element style="font-size: 24px"-->
- History
- Cookies
- Top Sites 
- Preferences
- Secure Preferences

:::

::: right
![[0x10_9370f4ef4d2c97a8_slide_14_image.png|300]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Interview Question:

:::

<!-- element style="font-size: 24px"-->
- You come across malware that is using a statically linked Sqlite client. What kind of malware is it most likely?

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Valid answers:

:::

<!-- element style="font-size: 24px"-->
- It is probably a stealer targeting browsers.
- More generally, it is doing something that requires interacting with a SQLite database
- The most common targets for commodity malware are browsers! Why?

---
<!-- slide template="[[Title Slide]]" -->
 Live Demo 
