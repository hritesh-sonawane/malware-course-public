---
theme: night
height: 540
margin: 0
maxScale: 4
slideNumber: true
---

<!-- slide bg="[[Green Logo.svg]]" background-size="auto" -->

---


<!-- slide template="[[Split Vertical]]" -->
::: title
#### CS-4973
:::
::: left
![[Green Logo.svg | 400]] <!-- element style="object-fit: cover" -->

:::
::: right
<!-- element style="font-size: 32px;align:center" -->
Introduction to Malware, Threat Hunting & Offensive Capabilities Development
:::



---
<!-- slide template="[[Title Slide]]" -->
 ## Lecture 0x0b: 
HTTP
---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Capstone: Developing your own Implant

:::

<!-- element style="font-size: 24px"-->
- To pass this class, you must develop a C2 Framework. 
- You may work in groups of up to 5 people. 
- You may not work alone. Infosec is a team sport. Go make some friends :-)
- The C2 framework must support an implant that communicates using HTTP
- All homework going forward is relevant to the capstone :)


---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### Example C2 Architecture 
:::

::: left
<!-- element style="font-size: 24px"-->
- Infected Machine connects directly to the C2 
- Commands are issued by the operator 


:::

::: right
![[0x0b_slide_4_image.png|800]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Terminology: Review

:::

<!-- element style="font-size: 24px"-->
- C2: Command and Control Server
- Implant: the malware “implanted” on a victim machine
- C2 Channel: The transport mechanism used by the implant and the C2 server to exchange data


---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### C2 Channel: HTTP
:::

<!-- element style="font-size: 24px"-->
- Example HTTP GET

![[0x0b_slide_6_image.png|800]]

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTP

:::

<!-- element style="font-size: 24px"-->
- Hypertext Transfer Protocol (HTTP)
- Protocol
 built on top of TCP that powers the web
- Used for (among other things) 
transferring
 data between a **
client and a server** 
- Think of TCP as a stream of data.
- Think of HTTP as a sequence of envelopes of data 
- Has 
multiple
different
 versions and extensions 

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTPs

:::

<!-- element style="font-size: 24px"-->
- Hypertext Transfer Protocol Secure (HTTPs) is the secure extensions of HTTP
- This requires the Remote server to authenticate itself to the client using Transport layer Security (TLS) which is built on top of TCP with Public Key Infrastructure (PKI)
- We will go into further detail once we get to the cryptography section, but PKI & TLS are  
prerequisites
 for this class. 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Tools to Play with TCP

:::

<!-- element style="font-size: 24px"-->
- netcat
- socat (way better)
	- See https://www.redhat.com/sysadmin/getting-started-socat
- Python3 socket

---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Socat Example
:::


![[0x0b_slide_10_image.png]]


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Tools to Play with HTTP (Client)	

:::

<!-- element style="font-size: 24px"-->
- socat 
- curl
- Wget
- Fiddler2
- ostman
- Python3 requests 
- BurpSuite (
recommended
 to get started)

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Anatomy of a URL

:::

<!-- element style="font-size: 24px"-->
- `<protocol>://<domain>:<port>/<path>`
- For example:
- http://example.com
/index.html
- (URL is a type of a URI)
- For more see https://www.geeksforgeeks.org/difference-between-url-and-uri/


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### URL

:::

<!-- element style="font-size: 24px"-->
- HTTP → port 80
- HTTPS→ port 443
- These are conventions used by browsers and most HTTP clients 
- I.e. 
http://example.com
http://example.com:80/
 are the same thing

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Anatomy of an HTTP Request 

:::

```
- <Verb> <PATH> <HTTP Version>
- <headers>...
- <BODY>
```


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTP Headers

:::

<!-- element style="font-size: 24px"-->
- Key/Value  stores of data
- Common headers: Cookies, host
- Can be whatever you want! 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### BurpSuite


:::

<!-- element style="font-size: 24px"-->
- Web penetration testing tool
- Has a free 
community
 version
- Intuitive
 UI, written in java
- Alternatives: Zap (big fan)
- Comes shipped with a preconfigured browser to strip TLS
- Please read 
https://portswigger.net/burp/documentation/desktop/penetration-testing

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Basics of BurpSuite

:::

<!-- element style="font-size: 24px"-->
- Proxy attack framework that proxies all HTTP traffic through a MITM proxy to allow for HTTP request introspection/modification
- By using a rogue certificate, HTTPs traffic can be decrypted
- Main tabs are 
	- Proxy: toggle intercept and proxy options
	- Repeater: replay HTTP requests (possibly modified)

---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### BurpSuite
:::


![[0x0b_slide_18_image.png]]




---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTP Verbs

:::

<!-- element style="font-size: 24px"-->
- Verb is the action the client wants the server to perform
- These are conventions! 
- Basic Verbs
- GET: fetch content from the server. Typically the client request has no HTTP body and the server returns content in the HTTP body
- POST: Submit data to the server, often times creating side effects. Data is 
submitted
 in the client HTTP body
- For more see https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTP GET

:::

<!-- element style="font-size: 24px"-->
- Retrieve
 content from a remote server
- This is what happens whenever you type a URL into web browser like chrome 

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example

:::

<!-- element style="font-size: 24px"-->
- socat - TCP4:example.com:80
- GET / HTTP/1.1
- Host: example.com

---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### HTTP Example
:::


![[0x0b_slide_22_image.png]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
 ####  HTTP Example Cont
:::


![[0x0b_slide_23_image.png]]




---
<!-- slide template="[[Base Slide]]" -->
::: title
 ####  HTTP Example Cont
:::


![[0x0b_slide_24_image.png]]



---
<!-- slide template="[[Base Slide]]" -->
::: title
#### POST

:::

<!-- element style="font-size: 24px"-->
- Send data to the server. Often times used in HTML forms. 
- I.e., when you log into a website


---
<!-- slide template="[[Base Slide]]" -->
::: title
 ####  POST Request
:::


![[0x0b_slide_26_image.png]]


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Anatomy of a Server Response 

```

- <HTTP Version> <Status Code> <Message>
- <HTTP headers>...
- <BODY>
```

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Server Side Status Codes 

:::

<!-- element style="font-size: 24px"-->
- Integer 
corresponding
 to the status of an HTTP Request 
- Returned by the server to tell the client if everything is good
- 2xx OK
- 3xx Go somewhere else
- 4xx You f*cked up
- 5xx I f*cked up
- We will not see a handful of status codes you will likely encounter during the project. 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### 2xx

:::

<!-- element style="font-size: 24px"-->
- 200: I (the server) have 
successfully
 serviced your request 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### 3xx

:::

<!-- element style="font-size: 24px"-->
- Usually used as part of a redirect to another resource
- You might see this if you try to go to /profile in the CTF and you are not signed in
- The server then redirects you to the /login resource 


---
<!-- slide template="[[Split Vertical]]" -->
::: title
 #### 4xx
:::

::: left
<!-- element style="font-size: 20px"-->
- You (the client) have made a mistake and I won’t service you
- 400 Bad Request: the client sent data to the server in a format it doesn’t understand
- 401: You are not logged in and I won’t service you
- 403 Forbidden: You are authenticated but I still won’t service you
- 404 Not Found: You asked for a resource that doesn’t exist 
- 405 Method not allowed: the client used an 
unsupported
 HTTP Verb


:::

::: right
![[0x0b_slide_31_image.png|300]]


:::

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### 5xx

:::

<!-- element style="font-size: 24px"-->
- 500 Internal Server Error: Catch all error for the server encountered an error while trying to service your request 
- 502 Bad 
Gateway: You are using a reverse proxy that tried to proxy a request to a server that it could not connect to
- FOr more see https://bobcares.com/blog/502-bad-gateway-nginx/


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### For more information…

:::

<!-- element style="font-size: 24px"-->
- See 
https://developer.mozilla.org/en-US/docs/Web/HTTP/Status
 for more information about status codes. 


---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### 
:::


![[0x0b_slide_34_image.png]]




---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTP Server

:::

<!-- element style="font-size: 24px"-->
- Server to service HTTP requests 
- This course will use Flask to 
implement
 the HTTP server 
- It is relatively bare bones, but has a rich ecosystem
- Core component is a Flask application that you create routes and handlers for 
- The handler will be invoked whenever a request is made to the specified route 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Flask 

:::

<!-- element style="font-size: 24px"-->
- Lightweight, no frills HTTP server
- Routing is handled by decorators 
- Contains various helper functions to easily parse and respond to requests
- Has a rich ecosystem for different database plugins 
- Is not production ready in and of itself-- requires a  Web Service Gateway Interface (WSGI) 

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example: Hello world 

:::

```python
from flask import Flask, request
app = Flask(__name__)
@app.route("/hello")
def hello():
    return "Hello world!"
```

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Learning Flask

:::

<!-- element style="font-size: 24px"-->
- You are expected to read through a flask tutorial 
- For example: 
https://www.tutorialspoint.com/flask/index.htm
- Often times, googling “how do i do x in Flask” will yield you a usable answer 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTP RPC

:::

<!-- element style="font-size: 24px"-->
- RPC: Remote Procedure Call 
- RPC is the protocol used to control a remote machine.
- The remote machine exposes some interface that 
contains
 a collection of functions that can be remotely invoked. 

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example: Double it 

:::

<!-- element style="font-size: 24px"-->
- Create a 
web server
 that handles the endpoint /double/<some int>
- And returns the doubled integer along with a helpful message
- This is an example of an RPC!


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### RPC in malware 

:::

<!-- element style="font-size: 24px"-->
- With malware, the RPC is exposed by implant! This the opposite of what we just did where the HTTP server executes the commands!
- Let’s consider the simple example of malware that only wishes to execute a handful of commands on a victim machine 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example: Whoami

:::

<!-- element style="font-size: 24px"-->
- Consider an RPC that exposes the following function:
- whoami: get the current user on the computer and send it back 
- This can be implemented in HTTP as follows:
- Server: Expose /whoami (GET) to task the client to execute whoami
- Server: Expose /whoami (POST) to receive the results
- Client: CHeck for tasks using GET /whoami. If the task is whoami: execute whoami and send the results in HTTP post 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Components of an RPC

:::

<!-- element style="font-size: 24px"-->
- Transport: The 
Protocol
 used to send and 
receive
 data 
- Message Format: the way in which data is structured 
- Exported Interfaces/Functions: the suite of functions supported by the RPC framework 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### RPC Example: Restful APIs

:::

<!-- element style="font-size: 24px"-->
- Transport is HTTP(s)
- Format is JavaScript Object Notation (JSON)

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### RESTFUL Example

:::

<!-- element style="font-size: 24px"-->
- RPC:
- whoami: 
Args→ None. Gets the current user
- hostname: 
Args→None. Gets the hostname
- double: 
Args→List of integers to double


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Example 1: HTTP Reverse Shell 

:::

<!-- element style="font-size: 24px"-->
- Malware makes an HTTP GET Request to the endpoint /commands 
- Server responds with a list of shell commands it wishes the implant to execute
- Malware responds with a post request containing the output of those commands 


---
<!-- slide template="[[Base Slide]]" -->
::: title
 #### Example 1: HTTP Reverse Shell 
:::

<center>
![[0x0b_slide_47_image.png| 400]]



---
<!-- slide template="[[Base Slide]]" -->
::: title
#### C2 Engineering Basics

:::

<!-- element style="font-size: 24px"-->
- Send data
- Get data 
- Profit 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Team Server

:::

<!-- element style="font-size: 24px"-->
- Consider the following:
- Multiple implants connect to the C2 
- Multiple operators connect to the C2 to control the agents 
- Operators need to be appraised of the activity of their colleagues and status updates of their agents
- Messages are sent from the teamserver to operators
- Example messages that operators would want to see
- A new bot has connected to the server 
- A bot has pulled down a task 
- A bot has sent data to the server  
- 	An operator has issued a command to an agent
- We will work up to this 


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Server Components and Concepts 

:::

<!-- element style="font-size: 24px"-->
- Listeners: a server that handles connections from implants
- HTTP Listener: a listener that 
services
 implants using HTTP endpoints

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Components of a C2

:::

<!-- element style="font-size: 24px"-->
- 3 programs:
- Implant: the malicious code that implements the RPC 
- Teamserver: the server controlling the implant 
- Client: the client code used by the operator to communicate with the Teamserver. Thus, allowing the client to control the implant. 

---
<!-- slide template="[[Title Slide]]" -->
 ## Discussion: 
Drawing out a C2 framework 
---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Basic Imports for our teamserver

:::


```python
from flask import Flask, request, jsonify
- Flask: flask application
- request:  http request object
- jsonify: method to create a json response 
```


---
<!-- slide template="[[Base Slide]]" -->
::: title
#### HTTP Client Windows C++

:::

<!-- element style="font-size: 24px"-->
- WinSock → TCP client but you can 
implement
 HTTP 
- WinHTTP → Commonly used by malware. **Easy to make proxy aware**
- WinInet → less common but still popular (i.e. Cobalt Strike) **easy to make proxy aware with authentication**
- External Library: Mixed results. Libcurl is a great choice but it requires statically linking a TLS library

---
<!-- slide template="[[Base Slide]]" -->
::: title
#### Advanced Concepts for your C2

:::

<!-- element style="font-size: 24px"-->
- Implant identification
- Job Identification 
- Flask Blueprints 
- Messaging 
- Databases
- Operator authentication 

