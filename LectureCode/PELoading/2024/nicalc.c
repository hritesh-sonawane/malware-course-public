#include "findk32.h"
#include "libloaderapi.h"
#include "minwindef.h"

// int main() {
int APIENTRY WinMain(HINSTANCE hInst, HINSTANCE hInstPrev, PSTR cmdline,
                     int cmdshow) {
  HMODULE hKernel32 = GetKernel32BaseAddress();
  // printf("Found Kernel32: %p\n", (void *)hKernel32);

  pGetProcAddress _GetProcAddress =
      (pGetProcAddress)FindGetProcAddress(hKernel32);
  // printf("Found GetProcAddress: %p\n", (void *)_GetProcAddress);
  // printf("Real GetProcAddress: %p\n",
  // GetProcAddress(hKernel32, "GetProcAddress"));
  pLoadLibraryA myLoadLibraryA =
      (pLoadLibraryA)_GetProcAddress(hKernel32, "LoadLibraryA");
  if (myLoadLibraryA == NULL) {
    // printf("Failed to find LoadLibraryA");
    return 1;
  }
  // Use myLoadLibraryA and myGetProcAddress to find CreateProcessA
  pCreateProcessA myCreateProcessA =
      (pCreateProcessA)_GetProcAddress(hKernel32, "CreateProcessA");
  if (!myCreateProcessA) {
    // printf("Failed to find CreateProcessA\n");
  }
  // Launch calc.exe
  STARTUPINFOA si;
  PROCESS_INFORMATION pi;
  ZeroMemory(&si, sizeof(si));
  si.cb = sizeof(si);
  ZeroMemory(&pi, sizeof(pi));
  // printf("Running CreateProcessA: %p %p\n", (void *)myCreateProcessA,
  //(void *)GetProcAddress(hKernel32, "CreateProcessA"));
  myCreateProcessA("C:\\Windows\\system32\\calc.exe", NULL, NULL, NULL, FALSE,
                   0, NULL, NULL, &si, &pi);
  // printf("Goodbye!\n");
  return 0;
}
